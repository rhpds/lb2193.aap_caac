---
# tasks file for aap
- name: Ensure ansible.cfg exists
  ansible.builtin.file:
    path: "{{ lb2193_aap_caac_aap_ansible_cfg_path }}"
    state: touch
    mode: "0644"

- name: Configure ansible.cfg for Private Automation Hub
  ansible.builtin.blockinfile:
    path: "{{ lb2193_aap_caac_aap_ansible_cfg_path }}"
    block: |
      [galaxy]
      server_list = {{ lb2193_aap_caac_aap_private_ah_repos | map(attribute='name') | join(', ') }}

      {% for repo in lb2193_aap_caac_aap_private_ah_repos %}
      [galaxy_server.{{ repo.name }}]
      url={{ repo.url }}
      username={{ lb2193_aap_caac_aap_private_ah_username }}
      password={{ lb2193_aap_caac_aap_private_ah_password }}
      {% endfor %}
    marker: "# {mark} ANSIBLE MANAGED PRIVATE AUTOMATION HUB CONFIGURATION"

- name: Clone of a github branch
  ansible.builtin.git:
    repo: '{{ lb2193_aap_caac_aap_github_repo }}'
    dest: '{{ lb2193_aap_caac_aap_clone_destination_path }}'
    single_branch: yes
    version: '{{ lb2193_aap_caac_aap_github_version }}'

- name: Install specific Ansible collections
  ansible.builtin.command: ansible-galaxy collection install {{ item }}
  loop: "{{ lb2193_aap_caac_aap_collections_list }}"
  when: lb2193_aap_caac_aap_collections_list | length > 0
  ignore_errors: yes

- name: Include collection remote role
  ansible.builtin.include_role:
    name: infra.aap_configuration.hub_collection_remote
  vars:
    hub_collection_remotes: '{{ lb2193_hub_collection_remotes }}'

- name: Include collection repository role
  ansible.builtin.include_role:
    name: infra.aap_configuration.hub_collection_repository
  vars:
    hub_collection_repositories: '{{ lb2193_hub_collection_repositories }}'

- name: Include collection repository role
  ansible.builtin.include_role:
    name: infra.aap_configuration.hub_collection_repository_sync
  vars:
    hub_collection_repositories: '{{ lb2193_hub_collection_repositories }}'
    hub_configuration_collection_repository_sync_async_delay: 5
    hub_configuration_collection_repository_sync_async_retries: 150
